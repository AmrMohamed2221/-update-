<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=JetBrains+Mono:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0a0c0f;--surface:#111418;--surface2:#181c22;--border:#1e2530;--accent:#e8b13a;--accent2:#3ab8e8;--red:#e84a3a;--green:#3ae89a;--orange:#e8743a;--text:#c8d0dc;--text-dim:#5a6478;--text-bright:#eef2f8;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'Cairo',sans-serif;min-height:100vh;overflow-x:hidden;direction:rtl;}
  body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.4;}

  /* LOGIN */
  #loginScreen{position:fixed;inset:0;background:var(--bg);z-index:5000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;}
  .login-box{background:var(--surface);border:1px solid var(--border);width:440px;max-width:95vw;padding:48px 40px;position:relative;overflow:hidden;}
  .login-box::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));}
  .login-logo{font-size:32px;font-weight:900;color:var(--accent);margin-bottom:4px;}
  .login-sub{font-size:11px;color:var(--text-dim);margin-bottom:32px;}
  .login-label{display:block;font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:6px;letter-spacing:1px;}
  .login-input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:14px;padding:12px 14px;outline:none;margin-bottom:16px;transition:border-color .2s;direction:rtl;}
  .login-input:focus{border-color:var(--accent);}
  .login-btn{width:100%;background:var(--accent);color:#000;border:none;font-family:'Cairo',sans-serif;font-size:16px;font-weight:900;padding:14px;cursor:pointer;transition:all .2s;margin-top:8px;}
  .login-btn:hover{background:#f5c85c;transform:translateY(-1px);}
  .login-error{background:rgba(232,74,58,.1);border:1px solid rgba(232,74,58,.4);color:var(--red);font-size:13px;font-weight:600;padding:10px 14px;margin-bottom:14px;display:none;}
  .login-error.show{display:block;}
  .login-creds-hint{background:var(--surface2);border:1px solid var(--border);padding:16px 20px;width:440px;max-width:95vw;font-size:11px;color:var(--text-dim);}
  .login-creds-hint strong{color:var(--accent);display:block;margin-bottom:8px;font-size:12px;}
  .creds-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 20px;}
  .creds-row{display:flex;justify-content:space-between;gap:8px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04);}
  .creds-row:last-child{border:none;}
  .creds-user{color:var(--text);font-family:'JetBrains Mono',monospace;font-size:10px;}
  .creds-pass{color:var(--accent);font-family:'JetBrains Mono',monospace;font-size:10px;}
  .loading-overlay{position:fixed;inset:0;background:rgba(10,12,15,.85);z-index:9000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
  .loading-overlay.show{display:flex;}
  .spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-text{font-size:13px;color:var(--text-dim);font-weight:600;}

  /* HEADER */
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:100;flex-wrap:wrap;gap:10px;}
  .logo{font-size:24px;font-weight:900;color:var(--accent);}
  .logo span{color:var(--text-dim);font-size:10px;display:block;margin-top:-2px;font-weight:400;}
  .header-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .user-chip{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);padding:6px 12px;font-size:12px;font-weight:700;}
  .role-badge{font-size:9px;padding:2px 8px;font-weight:700;}
  .role-badge.admin{background:rgba(232,177,58,.2);color:var(--accent);border:1px solid rgba(232,177,58,.3);}
  .role-badge.user{background:rgba(58,184,232,.2);color:var(--accent2);border:1px solid rgba(58,184,232,.3);}
  select.ctrl{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:12px;padding:7px 12px;cursor:pointer;outline:none;transition:border-color .2s;}
  select.ctrl:focus{border-color:var(--accent);}
  .sync-badge{font-size:10px;font-weight:600;padding:4px 10px;border:1px solid;font-family:'JetBrains Mono',monospace;}
  .sync-badge.synced{color:var(--green);border-color:rgba(58,232,154,.3);background:rgba(58,232,154,.07);}
  .sync-badge.saving{color:var(--accent);border-color:rgba(232,177,58,.3);background:rgba(232,177,58,.07);animation:blink .6s infinite;}
  @keyframes blink{50%{opacity:.4}}
  .sync-badge.error{color:var(--red);border-color:rgba(232,74,58,.3);}

  /* BUTTONS */
  .btn{background:var(--accent);color:#000;border:none;font-family:'Cairo',sans-serif;font-size:14px;font-weight:700;padding:8px 18px;cursor:pointer;transition:all .2s;display:inline-block;}
  .btn:hover{background:#f5c85c;transform:translateY(-1px);}
  .btn.secondary{background:transparent;border:1px solid var(--accent);color:var(--accent);}
  .btn.secondary:hover{background:var(--accent);color:#000;}
  .btn.danger{background:var(--red);color:#fff;}
  .btn.danger:hover{background:#ff5f4f;}
  .btn.sm{font-size:12px;padding:5px 10px;}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text-dim);font-size:13px;}
  .btn.ghost:hover{border-color:var(--accent);color:var(--accent);transform:none;}
  .btn.logout{background:transparent;border:1px solid var(--border);color:var(--text-dim);font-size:12px;padding:6px 12px;}
  .btn.logout:hover{border-color:var(--red);color:var(--red);transform:none;}

  /* LAYOUT */
  .main{display:grid;grid-template-columns:1fr 260px;min-height:calc(100vh - 57px);}
  aside{background:var(--surface);border-left:1px solid var(--border);padding:20px 0;position:sticky;top:57px;height:calc(100vh - 57px);overflow-y:auto;order:2;}
  .nav-label{font-size:9px;font-weight:700;color:var(--text-dim);padding:0 20px 8px;letter-spacing:2px;text-transform:uppercase;}
  .nav-item{display:flex;align-items:center;gap:10px;padding:11px 20px;cursor:pointer;transition:all .15s;border-right:3px solid transparent;font-size:14px;font-weight:600;color:var(--text-dim);}
  .nav-item:hover{background:var(--surface2);color:var(--text);border-right-color:var(--border);}
  .nav-item.active{background:var(--surface2);color:var(--accent);border-right-color:var(--accent);}
  .nav-item .icon{font-size:16px;width:22px;text-align:center;}
  .sidebar-divider{height:1px;background:var(--border);margin:12px 20px;}
  .sidebar-stat{padding:6px 20px;font-size:11px;display:flex;justify-content:space-between;color:var(--text-dim);}
  .sidebar-stat .val{font-weight:700;}
  .building-badge{background:rgba(232,177,58,.1);border:1px solid rgba(232,177,58,.25);color:var(--accent);font-size:11px;font-weight:700;padding:8px 20px;margin:6px 14px;text-align:center;}

  .content{padding:28px;overflow-y:auto;order:1;}
  .page{display:none;}
  .page.active{display:block;animation:fadeIn .25s ease;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  .page-title{font-size:36px;font-weight:900;color:var(--text-bright);line-height:1.1;margin-bottom:4px;}
  .page-subtitle{font-size:11px;color:var(--text-dim);margin-bottom:24px;}

  /* VEHICLE SPREADSHEET */
  .vsheet-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:0;}
  .vsheet{width:100%;border-collapse:collapse;font-size:13px;min-width:1000px;}
  .vsheet thead tr{background:var(--surface2);}
  .vsheet th{font-size:10px;font-weight:700;color:var(--text-dim);text-align:right;padding:11px 14px;border-bottom:2px solid var(--border);letter-spacing:1px;white-space:nowrap;position:sticky;top:0;background:var(--surface2);z-index:2;}
  .vsheet th:first-child{color:var(--text-dim);text-align:center;}
  .vsheet td{padding:10px 14px;border-bottom:1px solid var(--border);vertical-align:middle;white-space:nowrap;}
  .vsheet td.wrap{white-space:normal;min-width:160px;max-width:260px;}
  .vsheet tbody tr:hover td{background:rgba(232,177,58,.04);}
  .vsheet tbody tr:nth-child(even) td{background:rgba(255,255,255,.015);}
  .vsheet tbody tr:nth-child(even):hover td{background:rgba(232,177,58,.04);}
  .vsheet .row-num{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);text-align:center;padding-right:6px;}
  .vsheet .cell-num{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--text-bright);letter-spacing:1px;}
  .vsheet .cell-days{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;text-align:center;}
  .vsheet .cell-status select{background:transparent;border:none;color:inherit;font-family:'Cairo',sans-serif;font-size:12px;font-weight:700;padding:3px 6px;cursor:pointer;outline:none;width:100%;}
  .vsheet .st-dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin-left:6px;vertical-align:middle;flex-shrink:0;}
  .vsheet .cell-actions{display:flex;gap:5px;align-items:center;}
  .vsheet-empty{text-align:center;padding:50px;color:var(--text-dim);font-size:13px;}

  /* VEHICLES (old card styles kept for daily overview reuse) */
  .vehicles-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;}
  .vehicle-card{background:var(--surface);border:1px solid var(--border);padding:18px;position:relative;overflow:hidden;transition:border-color .2s,transform .2s;}
  .vehicle-card:hover{border-color:var(--accent);transform:translateY(-2px);}
  .vc-stripe{position:absolute;top:0;left:0;right:0;height:3px;}
  .vc-num{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:600;color:var(--text-bright);letter-spacing:2px;}
  .vc-type{font-size:11px;color:var(--text-dim);margin-bottom:10px;}
  .vc-row{display:flex;justify-content:space-between;font-size:12px;color:var(--text-dim);margin-bottom:3px;gap:8px;}
  .vc-row span{color:var(--text);font-size:11px;}
  .status-badge{display:inline-block;font-size:10px;font-weight:600;padding:3px 10px;margin-top:10px;border:1px solid;}
  .vc-actions{display:flex;gap:6px;margin-top:12px;}

  /* FILTER */
  .filter-bar{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap;align-items:center;}
  .filter-bar input{background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:12px;padding:8px 12px;outline:none;transition:border-color .2s;}
  .filter-bar input:focus{border-color:var(--accent);}
  .tag-row{display:flex;gap:5px;flex-wrap:wrap;}
  .tag{padding:4px 11px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border);transition:all .15s;color:var(--text-dim);background:transparent;}
  .tag.active,.tag:hover{border-color:var(--accent);color:var(--accent);background:rgba(232,177,58,.05);}

  /* MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
  .modal-overlay.open{display:flex;}
  .modal{background:var(--surface);border:1px solid var(--border);width:540px;max-width:95vw;max-height:90vh;overflow-y:auto;direction:rtl;}
  .modal-header{display:flex;justify-content:space-between;align-items:center;padding:18px 22px;border-bottom:1px solid var(--border);}
  .modal-title{font-size:20px;font-weight:900;color:var(--text-bright);}
  .modal-close{background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;}
  .modal-close:hover{color:var(--red);}
  .modal-body{padding:22px;}
  .modal-footer{display:flex;gap:10px;justify-content:flex-start;padding:14px 22px;border-top:1px solid var(--border);}
  .form-group{margin-bottom:16px;}
  .form-label{display:block;font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:5px;}
  .form-input,.form-select,.form-textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:13px;padding:9px 12px;outline:none;transition:border-color .2s;direction:rtl;}
  .form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent);}
  .form-textarea{resize:vertical;min-height:75px;}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}

  /* REPORTS */
  .reports-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px;margin-bottom:28px;}
  .report-card{background:var(--surface);border:1px solid var(--border);padding:22px 18px;position:relative;overflow:hidden;}
  .report-card::after{content:'';position:absolute;bottom:0;right:0;width:60px;height:60px;background:radial-gradient(circle,rgba(232,177,58,.08) 0%,transparent 70%);}
  .report-icon{font-size:26px;margin-bottom:10px;}
  .report-value{font-size:42px;font-weight:900;color:var(--accent);line-height:1;margin-bottom:4px;}
  .report-label{font-size:11px;font-weight:600;color:var(--text-dim);}
  .chart-section{background:var(--surface);border:1px solid var(--border);padding:22px;margin-bottom:18px;}
  .chart-title{font-size:18px;font-weight:700;color:var(--text-bright);margin-bottom:18px;}
  .bar-chart{display:flex;align-items:flex-end;gap:5px;height:130px;overflow-x:auto;padding-bottom:4px;}
  .bar-group{display:flex;flex-direction:column;align-items:center;gap:5px;flex:1;min-width:34px;}
  .bar{width:100%;background:linear-gradient(180deg,var(--accent),rgba(232,177,58,.3));border-top:2px solid var(--accent);min-height:4px;}
  .bar:hover{opacity:.7;}
  .bar-label{font-size:9px;color:var(--text-dim);text-align:center;font-weight:600;}
  .bar-val{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);}
  .status-breakdown{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-bottom:22px;}
  .sb-card{background:var(--surface);border:1px solid var(--border);padding:14px;text-align:center;}
  .sb-val{font-size:34px;font-weight:900;}
  .sb-lab{font-size:10px;font-weight:600;color:var(--text-dim);}

  /* SETTINGS */
  .settings-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:20px;}
  .settings-card{background:var(--surface);border:1px solid var(--border);padding:22px;}
  .settings-card-title{font-size:19px;font-weight:700;color:var(--text-bright);margin-bottom:4px;}
  .settings-card-sub{font-size:10px;color:var(--text-dim);margin-bottom:16px;}
  .item-list{list-style:none;margin-bottom:14px;}
  .item-list li{padding:7px 0;border-bottom:1px solid var(--border);}
  .item-list li:last-child{border-bottom:none;}
  .item-row{display:flex;align-items:center;gap:7px;}
  .item-color-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
  .item-name{flex:1;font-size:13px;color:var(--text);}
  .item-edit-row{display:none;margin-top:7px;gap:5px;align-items:center;}
  .item-edit-row.active{display:flex;}
  .item-edit-row input{flex:1;background:var(--bg);border:1px solid var(--accent);color:var(--text);font-family:'Cairo',sans-serif;font-size:13px;padding:5px 9px;outline:none;}
  .add-item-row{display:flex;gap:7px;margin-top:4px;}
  .add-item-row input{flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:13px;padding:7px 11px;outline:none;transition:border-color .2s;}
  .add-item-row input:focus{border-color:var(--accent);}
  .color-swatches{display:flex;gap:5px;flex-wrap:wrap;margin-top:7px;}
  .swatch{width:21px;height:21px;cursor:pointer;border:2px solid transparent;transition:border-color .15s;}
  .swatch.selected{border-color:#fff;outline:1px solid #666;}

  /* USERS TABLE */
  .user-table{width:100%;border-collapse:collapse;}
  .user-table th{font-size:10px;font-weight:700;color:var(--text-dim);text-align:right;padding:10px 12px;border-bottom:1px solid var(--border);background:var(--surface2);letter-spacing:1px;}
  .user-table td{padding:10px 12px;font-size:13px;border-bottom:1px solid var(--border);vertical-align:middle;}
  .user-table tr:hover td{background:var(--surface2);}

  /* DATA INFO */
  .data-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;}
  .data-info{font-size:12px;color:var(--text-dim);margin-bottom:12px;line-height:2;}
  .data-info span{color:var(--accent);font-weight:700;}
  .danger-zone{margin-top:18px;padding-top:14px;border-top:1px solid rgba(232,74,58,.2);}
  .danger-zone-label{font-size:10px;color:var(--red);margin-bottom:8px;font-weight:700;letter-spacing:1px;}

  /* TOAST */
  .toast{position:fixed;bottom:22px;left:22px;background:var(--surface);border:1px solid var(--green);color:var(--green);font-family:'Cairo',sans-serif;font-size:12px;font-weight:600;padding:11px 18px;z-index:8000;transform:translateY(80px);opacity:0;transition:all .3s;max-width:300px;}
  .toast.show{transform:translateY(0);opacity:1;}
  .empty{text-align:center;padding:55px 20px;color:var(--text-dim);font-size:13px;}
  .empty-icon{font-size:44px;margin-bottom:14px;opacity:0.3;}

  /* DAILY OVERVIEW */
  .daily-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:22px;flex-wrap:wrap;gap:12px;}
  .daily-date-badge{background:var(--surface);border:1px solid var(--accent);padding:12px 20px;text-align:center;min-width:140px;}
  .daily-date-badge .ddb-day{font-size:32px;font-weight:900;color:var(--accent);line-height:1;}
  .daily-date-badge .ddb-full{font-size:11px;color:var(--text-dim);margin-top:4px;font-weight:600;}
  .daily-kpi-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:12px;margin-bottom:26px;}
  .daily-kpi{background:var(--surface);border:1px solid var(--border);padding:18px 16px;position:relative;overflow:hidden;border-top:3px solid var(--border);}
  .daily-kpi.accent{border-top-color:var(--accent);}
  .daily-kpi.green{border-top-color:var(--green);}
  .daily-kpi.blue{border-top-color:var(--accent2);}
  .daily-kpi.red{border-top-color:var(--red);}
  .daily-kpi.orange{border-top-color:var(--orange);}
  .kpi-icon{font-size:20px;margin-bottom:8px;}
  .kpi-val{font-size:38px;font-weight:900;color:var(--text-bright);line-height:1;margin-bottom:4px;}
  .kpi-val.green{color:var(--green);}
  .kpi-val.blue{color:var(--accent2);}
  .kpi-val.red{color:var(--red);}
  .kpi-val.accent{color:var(--accent);}
  .kpi-val.orange{color:var(--orange);}
  .kpi-lab{font-size:10px;font-weight:700;color:var(--text-dim);}
  .daily-section{background:var(--surface);border:1px solid var(--border);padding:22px;margin-bottom:18px;}
  .daily-section-title{font-size:17px;font-weight:900;color:var(--text-bright);margin-bottom:4px;}
  .daily-section-sub{font-size:11px;color:var(--text-dim);margin-bottom:16px;}
  .daily-table-wrap{overflow-x:auto;}
  .daily-table{width:100%;border-collapse:collapse;font-size:13px;}
  .daily-table th{font-size:10px;font-weight:700;color:var(--text-dim);text-align:right;padding:9px 12px;border-bottom:1px solid var(--border);background:var(--surface2);letter-spacing:1px;white-space:nowrap;}
  .daily-table td{padding:9px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
  .daily-table tr:last-child td{border-bottom:none;}
  .daily-table tr:hover td{background:var(--surface2);}
  .daily-table .st-pill{display:inline-block;font-size:9px;font-weight:700;padding:2px 9px;border:1px solid;white-space:nowrap;}
  .daily-empty{text-align:center;padding:24px;color:var(--text-dim);font-size:12px;font-style:italic;}
  .daily-bld-group{margin-bottom:14px;}
  .daily-bld-label{font-size:12px;font-weight:700;color:var(--accent);padding:6px 0;border-bottom:1px solid var(--border);margin-bottom:8px;display:flex;align-items:center;gap:8px;}
  .daily-bld-label span{background:rgba(232,177,58,.1);border:1px solid rgba(232,177,58,.2);padding:2px 10px;font-size:10px;}
  .daily-low-parts{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;}
  .low-part-card{background:var(--surface2);border:1px solid rgba(232,74,58,.25);padding:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
  .low-part-info{}
  .low-part-name{font-size:13px;font-weight:700;color:var(--text-bright);}
  .low-part-meta{font-size:10px;color:var(--text-dim);margin-top:2px;}
  .low-part-qty{font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;color:var(--red);line-height:1;}
  .storage-header{display:flex;align-items:center;gap:14px;margin-bottom:22px;flex-wrap:wrap;}
  .storage-type-select{background:var(--bg);border:1px solid var(--accent);color:var(--text-bright);font-family:'Cairo',sans-serif;font-size:15px;font-weight:700;padding:10px 18px;outline:none;cursor:pointer;min-width:220px;}
  .parts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-bottom:28px;}
  .part-card{background:var(--surface);border:1px solid var(--border);padding:18px;position:relative;transition:border-color .2s;}
  .part-card:hover{border-color:var(--accent);}
  .part-card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;}
  .part-name{font-size:15px;font-weight:700;color:var(--text-bright);flex:1;line-height:1.3;}
  .part-qty-box{display:flex;flex-direction:column;align-items:center;background:var(--surface2);border:1px solid var(--border);padding:8px 14px;min-width:64px;text-align:center;}
  .part-qty-num{font-family:'JetBrains Mono',monospace;font-size:26px;font-weight:700;line-height:1;}
  .part-qty-label{font-size:9px;color:var(--text-dim);font-weight:600;margin-top:2px;}
  .part-qty-low{color:var(--red);}
  .part-qty-ok{color:var(--green);}
  .part-qty-mid{color:var(--accent);}
  .part-meta{font-size:11px;color:var(--text-dim);margin-bottom:12px;}
  .part-actions{display:flex;gap:6px;align-items:center;}
  .qty-btn{width:30px;height:30px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:18px;font-weight:700;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
  .qty-btn:hover{border-color:var(--accent);color:var(--accent);}
  .qty-input{width:60px;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:13px;padding:5px 8px;outline:none;text-align:center;}
  .qty-input:focus{border-color:var(--accent);}
  .add-part-card{background:var(--surface);border:2px dashed var(--border);padding:22px;transition:border-color .2s;cursor:pointer;}
  .add-part-card:hover{border-color:var(--accent);}
  .add-part-form{display:flex;flex-direction:column;gap:10px;}
  .storage-summary{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:22px;}
  .stor-stat{background:var(--surface);border:1px solid var(--border);padding:16px;text-align:center;}
  .stor-stat-val{font-size:30px;font-weight:900;color:var(--accent);}
  .stor-stat-lab{font-size:10px;color:var(--text-dim);font-weight:600;margin-top:2px;}

  .storage-header input[type="text"]:focus{border-color:var(--accent);}
  .stor-kpi-row{display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap;}
  .stor-kpi-row .stor-stat{flex:1;min-width:120px;text-align:center;}

  /* STORAGE SPREADSHEET (Ù…Ø®Ø²Ù† 4) */
  .ssheet-input{background:transparent;border:none;color:var(--text);font-family:'Cairo',sans-serif;font-size:13px;width:100%;outline:none;padding:2px 4px;}
  .ssheet-input:focus{background:rgba(232,177,58,.08);border-bottom:1px solid var(--accent);}
  .ssheet-input.mono{font-family:'JetBrains Mono',monospace;font-size:12px;}
  .ssheet-qty{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;width:60px;background:transparent;border:none;color:var(--text);text-align:center;outline:none;padding:2px;}
  .ssheet-qty:focus{background:rgba(232,177,58,.08);}
  .qty-color-ok{color:var(--green);}
  .qty-color-mid{color:var(--accent);}
  .qty-color-low{color:var(--red);}
  .ssheet-add-row td{background:rgba(232,177,58,.04);border-top:2px dashed rgba(232,177,58,.2);}
  .ssheet-add-row input{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:12px;padding:6px 9px;outline:none;width:100%;transition:border-color .2s;}
  .ssheet-add-row input:focus{border-color:var(--accent);}
  .ssheet-add-row input.mono{font-family:'JetBrains Mono',monospace;}
  ::-webkit-scrollbar{width:5px;height:5px;}
  ::-webkit-scrollbar-track{background:var(--bg);}
  ::-webkit-scrollbar-thumb{background:var(--border);}
  @media(max-width:768px){.main{grid-template-columns:1fr;}aside{display:none;}.form-row{grid-template-columns:1fr;}header{padding:10px 14px;}.content{padding:14px;}}
</style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Ø¬Ø§Ø±Ù Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
</div>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬</div>
    <div class="login-sub">// Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª â€” ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
    <div class="login-error" id="loginError">âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
    <label class="login-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
    <input class="login-input" id="loginUser" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" onkeydown="if(event.key==='Enter')document.getElementById('loginPass').focus()" autocomplete="username"/>
    <label class="login-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input class="login-input" id="loginPass" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" onkeydown="if(event.key==='Enter')doLogin()" autocomplete="current-password"/>
    <button class="login-btn" onclick="doLogin()">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </div>

</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<header>
  <div class="logo">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ <span>// Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</span></div>
  <div class="header-controls">
    <div class="sync-badge" id="syncBadge">âŸ³ Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
    <div class="user-chip"><span id="userChipName">â€”</span><span class="role-badge" id="userChipRole">â€”</span></div>
    <select class="ctrl" id="buildingSelect" onchange="filterBuilding()"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</option></select>
    <button class="btn" onclick="openAddModal()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙƒØ¨Ø©</button>
    <button class="btn logout" onclick="doLogout()">Ø®Ø±ÙˆØ¬ â†©</button>
  </div>
</header>

<div class="main">
  <aside>
    <div class="nav-label">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
    <div class="nav-item active" onclick="showPage('vehicles',this)"><span class="icon">ğŸš—</span> Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
    <div class="nav-item" onclick="showPage('daily',this)"><span class="icon">ğŸ—“ï¸</span> Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
    <div class="nav-item" onclick="showPage('reports',this)"><span class="icon">ğŸ“Š</span> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    <div class="nav-item" onclick="showPage('storage1',this)"><span class="icon">ğŸ“¦</span> Ù…Ø®Ø²Ù† 4</div>
    <div class="nav-item" onclick="showPage('storage2',this)"><span class="icon">ğŸ—„ï¸</span> Ù…Ø®Ø²Ù† MRAP</div>
    <div class="nav-item admin-only" onclick="showPage('settings',this)"><span class="icon">âš™ï¸</span> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    <div class="sidebar-divider"></div>
    <div id="buildingBadge" style="display:none" class="building-badge"></div>
    <div class="nav-label">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
    <div class="sidebar-stat"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</span><span class="val" id="sb-total" style="color:var(--accent)">0</span></div>
    <div id="sb-status-list"></div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-stat"><span>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥ØµÙ„Ø§Ø­</span><span class="val" id="sb-avg" style="color:var(--accent)">â€”</span></div>
  </aside>

  <div class="content">

    <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª -->
    <div class="page active" id="page-vehicles">
      <div class="page-title">Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
      <div class="page-subtitle" id="vehicles-subtitle">// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ©</div>
      <div class="filter-bar">
        <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø£Ùˆ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³..." id="searchInput" oninput="renderVehicles()" style="min-width:210px;">
        <div class="tag-row" id="statusFilterTags"></div>
      </div>
      <div class="vsheet-wrap">
        <table class="vsheet" id="vehiclesGrid">
          <thead>
            <tr>
              <th style="width:36px">#</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</th>
              <th>Ø§Ù„Ù†ÙˆØ¹</th>
              <th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
              <th>Ø§Ù„Ø£ÙŠØ§Ù…</th>
              <th>Ø§Ù„Ø¶Ø§Ø¨Ø· / Ø¶Ø§Ø¨Ø· Ø§Ù„ØµÙ</th>
              <th>Ø±Ù‚Ù… ØªØµØ¯ÙŠÙ‚</th>
              <th>Ø±Ù‚Ù… Ø¥Ø°Ù† Ø§Ù„Ø´ØºÙ„</th>
              <th>Ø§Ù„Ø¹Ø·Ù„</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="vehiclesBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
    <div class="page" id="page-daily">
      <div class="daily-header">
        <div>
          <div class="page-title">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
          <div class="page-subtitle" id="daily-date-sub">// Ù…Ù„Ø®Øµ ÙŠÙˆÙ… Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
        <div class="daily-date-badge" id="dailyDateBadge"></div>
      </div>

      <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù„Ø®Øµ -->
      <div class="daily-kpi-row" id="dailyKpiRow"></div>

      <!-- Ù‚Ø³Ù…: Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„ØªÙŠ Ø¯Ø®Ù„Øª Ø§Ù„ÙŠÙˆÙ… -->
      <div class="daily-section">
        <div class="daily-section-title">ğŸš— Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„ØªÙŠ Ø¯Ø®Ù„Øª Ø§Ù„ÙŠÙˆÙ…</div>
        <div class="daily-section-sub" id="daily-entered-sub"></div>
        <div class="daily-table-wrap">
          <table class="daily-table" id="dailyEnteredTable">
            <thead><tr>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
              <th>Ø§Ù„Ø¶Ø§Ø¨Ø· / Ø¶Ø§Ø¨Ø· Ø§Ù„ØµÙ</th><th>Ø§Ù„Ø¹Ø·Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr></thead>
            <tbody id="dailyEnteredBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Ù‚Ø³Ù…: Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø© Ø§Ù„ÙŠÙˆÙ… -->
      <div class="daily-section">
        <div class="daily-section-title">âœ… Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø© Ø§Ù„ÙŠÙˆÙ…</div>
        <div class="daily-section-sub" id="daily-done-sub"></div>
        <div class="daily-table-wrap">
          <table class="daily-table" id="dailyDoneTable">
            <thead><tr>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
              <th>Ø§Ù„Ø¶Ø§Ø¨Ø· / Ø¶Ø§Ø¨Ø· Ø§Ù„ØµÙ</th><th>Ø§Ù„Ø¹Ø·Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr></thead>
            <tbody id="dailyDoneBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Ù‚Ø³Ù…: Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹ -->
      <div class="daily-section">
        <div class="daily-section-title">ğŸ”§ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹</div>
        <div class="daily-section-sub" id="daily-active-sub"></div>
        <div id="dailyActiveBldGroups"></div>
      </div>

      <!-- Ù‚Ø³Ù…: Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø© -->
      <div class="daily-section" id="daily-low-parts-section">
        <div class="daily-section-title">âš ï¸ Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
        <div class="daily-section-sub">// Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„ØªÙŠ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ ØªØ­Ø°ÙŠØ±ÙŠ (2 Ø£Ùˆ Ø£Ù‚Ù„)</div>
        <div class="daily-low-parts" id="dailyLowParts"></div>
      </div>

    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <div class="page" id="page-reports">
      <div class="page-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
      <div class="page-subtitle">// Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</div>
      <div class="reports-grid" id="reportsGrid"></div>
      <div class="status-breakdown" id="statusBreakdown"></div>
      <div class="chart-section" id="bldChartSection">
        <div class="chart-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ù„ÙƒÙ„ Ù…Ø¨Ù†Ù‰</div>
        <div class="bar-chart" id="buildingChart"></div>
      </div>
      <div class="chart-section">
        <div class="chart-title">Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© â€” Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</div>
        <div class="bar-chart" id="dailyChart"></div>
      </div>
    </div>

    <!-- ØµÙØ­Ø© Ù…Ø®Ø²Ù† 4 -->
    <div class="page" id="page-storage1">
      <div class="page-title">ğŸ“¦ Ù…Ø®Ø²Ù† 4</div>
      <div class="page-subtitle">// Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± â€” Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù„Ø¹Ø±Ø¶ Ù‚Ø·Ø¹Ù‡Ø§</div>
      <div id="storage1-summary" class="stor-kpi-row"></div>
      <div class="storage-header">
        <select class="storage-type-select" id="storageTypeSelect1" onchange="renderStorage(1)">
          <option value="">â€” Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© â€”</option>
        </select>
        <input type="text" id="storageSearch1" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø£Ø³Ù… Ø§Ù„ØµÙ†Ù Ø£Ùˆ NSN Ø£Ùˆ P/N..." oninput="renderStorage(1)"
          style="background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:13px;padding:9px 14px;outline:none;transition:border-color .2s;flex:1;min-width:200px;direction:rtl;">
      </div>
      <div class="vsheet-wrap" id="partsSheet1" style="display:none;margin-bottom:18px">
        <table class="vsheet">
          <thead><tr>
            <th style="width:42px">Ù…</th>
            <th>Ø£Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
            <th>NSN</th>
            <th>P/N</th>
            <th style="width:110px">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th style="width:80px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr></thead>
          <tbody id="partsBody1"></tbody>
          <tfoot id="partsTfoot1"></tfoot>
        </table>
      </div>
      <div id="partsGrid1"></div>
    </div>

    <!-- ØµÙØ­Ø© Ù…Ø®Ø²Ù† MRAP -->
    <div class="page" id="page-storage2">
      <div class="page-title">ğŸ—„ï¸ Ù…Ø®Ø²Ù† MRAP</div>
      <div class="page-subtitle">// Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± â€” Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù„Ø¹Ø±Ø¶ Ù‚Ø·Ø¹Ù‡Ø§</div>
      <div id="storage2-summary" class="stor-kpi-row"></div>
      <div class="storage-header">
        <select class="storage-type-select" id="storageTypeSelect2" onchange="renderStorage(2)">
          <option value="">â€” Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© â€”</option>
          <option value="RG 33 Plus">RG 33 Plus</option>
          <option value="RG 33">RG 33</option>
          <option value="Caiman">Caiman</option>
          <option value="Caiman Plus">Caiman Plus</option>
          <option value="MRV">MRV</option>
        </select>
        <input type="text" id="storageSearch2" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø£Ø³Ù… Ø§Ù„ØµÙ†Ù Ø£Ùˆ NSN Ø£Ùˆ P/N..." oninput="renderStorage(2)"
          style="background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:13px;padding:9px 14px;outline:none;transition:border-color .2s;flex:1;min-width:200px;direction:rtl;">
      </div>
      <div class="vsheet-wrap" id="partsSheet2" style="display:none;margin-bottom:18px">
        <table class="vsheet">
          <thead><tr>
            <th style="width:42px">Ù…</th>
            <th>Ø£Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
            <th>NSN</th>
            <th>P/N</th>
            <th style="width:110px">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th style="width:80px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr></thead>
          <tbody id="partsBody2"></tbody>
          <tfoot id="partsTfoot2"></tfoot>
        </table>
      </div>
      <div id="partsGrid2"></div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø£Ø¯Ù…Ù† ÙÙ‚Ø·) -->
    <div class="page" id="page-settings">
      <div class="page-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
      <div class="page-subtitle">// Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØªÙØ­ÙØ¸ ÙˆØªÙØ²Ø§Ù…Ù† Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙˆØ±Ø§Ù‹</div>
      <div class="settings-grid">
        <div class="settings-card">
          <div class="settings-card-title">ğŸ¢ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</div>
          <div class="settings-card-sub">// Ø§Ø¶ØºØ· ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©</div>
          <ul class="item-list" id="buildings-list"></ul>
          <div class="add-item-row">
            <input type="text" id="new-building" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰..." onkeydown="if(event.key==='Enter')addBuilding()"/>
            <button class="btn sm" onclick="addBuilding()">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>
        <div class="settings-card">
          <div class="settings-card-title">ğŸš— Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</div>
          <div class="settings-card-sub">// Ø§Ø¶ØºØ· ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©</div>
          <ul class="item-list" id="types-list"></ul>
          <div class="add-item-row">
            <input type="text" id="new-type" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©..." onkeydown="if(event.key==='Enter')addType()"/>
            <button class="btn sm" onclick="addType()">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>
        <div class="settings-card">
          <div class="settings-card-title">ğŸ“‹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div>
          <div class="settings-card-sub">// Ø§Ø¶ØºØ· ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©</div>
          <ul class="item-list" id="statuses-list"></ul>
          <div class="add-item-row">
            <input type="text" id="new-status" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø©..." onkeydown="if(event.key==='Enter')addStatus()"/>
            <button class="btn sm" onclick="addStatus()">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
          <div style="margin-top:12px;font-size:10px;color:var(--text-dim);margin-bottom:5px;font-weight:700;">Ù„ÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div>
          <div class="color-swatches" id="colorSwatches"></div>
        </div>
        <div class="settings-card">
          <div class="settings-card-title">ğŸ’¾ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
          <div class="settings-card-sub">// Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØªØµØ¯ÙŠØ±</div>
          <div class="data-info" id="dataInfo">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
          <div class="data-actions">
            <button class="btn sm" onclick="forceSave()">â˜ Ø­ÙØ¸ ÙˆØªØ²Ø§Ù…Ù†</button>
            <button class="btn sm secondary" onclick="exportData()">â¬‡ ØªØµØ¯ÙŠØ± JSON</button>
            <label class="btn sm secondary" style="cursor:pointer">â¬† Ø§Ø³ØªÙŠØ±Ø§Ø¯<input type="file" accept=".json" onchange="importData(event)" style="display:none"></label>
          </div>
          <div class="danger-zone">
            <div class="danger-zone-label">// Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</div>
            <button class="btn sm danger" onclick="resetToDefaults()">â†º Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ø±ÙƒØ¨Ø© -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOuter(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙƒØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="f-id"/>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø© *</label><input class="form-input" id="f-num" placeholder="Ù…Ø«Ø§Ù„: VH-0042"/></div>
        <div class="form-group"><label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© *</label><select class="form-select" id="f-type"></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„ *</label><input class="form-input" id="f-date" type="date"/></div>
        <div class="form-group" id="modal-building-group"><label class="form-label">Ø§Ù„Ù…Ø¨Ù†Ù‰</label><select class="form-select" id="f-building"></select></div>
      </div>
      <div class="form-group"><label class="form-label">Ø§Ù„Ø¶Ø§Ø¨Ø· / Ø¶Ø§Ø¨Ø· Ø§Ù„ØµÙ</label><input class="form-input" id="f-eng" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¶Ø§Ø¨Ø· Ø£Ùˆ Ø¶Ø§Ø¨Ø· Ø§Ù„ØµÙ"/></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Ø±Ù‚Ù… ØªØµØ¯ÙŠÙ‚</label><input class="form-input" id="f-tasdiq" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØµØ¯ÙŠÙ‚..."/></div>
        <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø¥Ø°Ù† Ø§Ù„Ø´ØºÙ„</label><input class="form-input" id="f-izn" placeholder="Ø±Ù‚Ù… Ø¥Ø°Ù† Ø§Ù„Ø´ØºÙ„..."/></div>
      </div>
      <div class="form-group"><label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„ *</label><input class="form-input" id="f-fault" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„..."/></div>
      <div class="form-group"><label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ *</label><select class="form-select" id="f-status"></select></div>
      <div class="form-group"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea class="form-textarea" id="f-notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn" onclick="saveVehicle()">Ø­ÙØ¸ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† â€” Ù…Ø­ÙÙˆØ¸ÙˆÙ† ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø© (Ø«Ø§Ø¨ØªÙˆÙ† Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const USERS = [
  { username:'admin',   password:'admin2024', role:'admin', building:null, display:'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…'    },
  { username:'Ù…Ø¨Ù†Ù‰1',  password:'b1pass',    role:'user',  building:'B1', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 1'  },
  { username:'Ù…Ø¨Ù†Ù‰2',  password:'b2pass',    role:'user',  building:'B2', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 2'  },
  { username:'Ù…Ø¨Ù†Ù‰3',  password:'b3pass',    role:'user',  building:'B3', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 3'  },
  { username:'Ù…Ø¨Ù†Ù‰4',  password:'b4pass',    role:'user',  building:'B4', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 4'  },
  { username:'Ù…Ø¨Ù†Ù‰5',  password:'b5pass',    role:'user',  building:'B5', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 5'  },
  { username:'Ù…Ø¨Ù†Ù‰6',  password:'b6pass',    role:'user',  building:'B6', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 6'  },
  { username:'Ù…Ø¨Ù†Ù‰7',  password:'b7pass',    role:'user',  building:'B7', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 7'  },
  { username:'Ù…Ø¨Ù†Ù‰8',  password:'b8pass',    role:'user',  building:'B8', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 8'  },
  { username:'Ù…Ø¨Ù†Ù‰9',  password:'b9pass',    role:'user',  building:'B9', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 9'  },
  { username:'Ù…Ø¨Ù†Ù‰10', password:'b10pass',   role:'user',  building:'B10',display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 10' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_DATA = {
  buildings:[
    {id:'B1',name:'Ù…Ø¨Ù†Ù‰ 1'},{id:'B2',name:'Ù…Ø¨Ù†Ù‰ 2'},{id:'B3',name:'Ù…Ø¨Ù†Ù‰ 3'},
    {id:'B4',name:'Ù…Ø¨Ù†Ù‰ 4'},{id:'B5',name:'Ù…Ø¨Ù†Ù‰ 5'},{id:'B6',name:'Ù…Ø¨Ù†Ù‰ 6'},
    {id:'B7',name:'Ù…Ø¨Ù†Ù‰ 7'},{id:'B8',name:'Ù…Ø¨Ù†Ù‰ 8'},{id:'B9',name:'Ù…Ø¨Ù†Ù‰ 9'},
    {id:'B10',name:'Ù…Ø¨Ù†Ù‰ 10'},
  ],
  vehicleTypes:['Ø³ÙŠØ§Ø±Ø©','Ù…Ø±Ø§Ø¨','Ù…Ø¯Ø±Ø¹Ø©','Ø´Ø§Ø­Ù†Ø©','Ù†Ø§Ù‚Ù„Ø© Ø¬Ù†Ø¯ Ù…Ø¯Ø±Ø¹Ø©','Ù‡Ø§Ù…ÙÙŠ','Ø¯Ø±Ø§Ø¬Ø© Ù†Ø§Ø±ÙŠØ©'],
  statuses:[
    {id:'repair',name:'ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­',color:'#e8743a'},
    {id:'awaiting',name:'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±',color:'#3ab8e8'},
    {id:'repaired',name:'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­',color:'#3ae89a'},
    {id:'delivered',name:'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…',color:'#5a6478'},
  ],
  vehicles:[
    {id:1,num:'VH-0017',type:'Ù…Ø±Ø§Ø¨',           date:'2026-02-10',building:'B1', engineer:'Ù†Ù‚ÙŠØ¨ Ø­Ø³Ù†',   fault:'Ø¹Ø·Ù„ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ùƒ',          status:'repair',   notes:''},
    {id:2,num:'VH-0033',type:'Ù…Ø¯Ø±Ø¹Ø©',          date:'2026-02-12',building:'B3', engineer:'Ø±Ù‚ÙŠØ¨ Ø®Ø§Ù„Ø¯', fault:'ØªÙ„Ù ÙÙŠ Ù†Ø§Ù‚Ù„ Ø§Ù„Ø­Ø±ÙƒØ©',     status:'awaiting', notes:'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±'},
    {id:3,num:'VH-0005',type:'Ø³ÙŠØ§Ø±Ø©',          date:'2026-02-05',building:'B2', engineer:'Ù…Ù„Ø§Ø²Ù… Ø¹Ù…Ø±',  fault:'Ø¹Ø·Ù„ ÙÙŠ Ø§Ù„ÙØ±Ø§Ù…Ù„',         status:'repaired', notes:'Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ÙØ­Øµ'},
    {id:4,num:'VH-0041',type:'Ø´Ø§Ø­Ù†Ø©',          date:'2026-02-08',building:'B5', engineer:'Ù†Ù‚ÙŠØ¨ ÙŠÙˆØ³Ù', fault:'ØªÙ„Ù ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚',         status:'delivered',notes:''},
    {id:5,num:'VH-0022',type:'Ù‡Ø§Ù…ÙÙŠ',          date:'2026-02-14',building:'B4', engineer:'Ø±Ù‚ÙŠØ¨ Ø­Ø³Ù†',  fault:'Ù‚ØµØ± ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ',            status:'repair',   notes:''},
    {id:6,num:'VH-0009',type:'Ù†Ø§Ù‚Ù„Ø© Ø¬Ù†Ø¯ Ù…Ø¯Ø±Ø¹Ø©',date:'2026-02-13',building:'B7', engineer:'Ø±Ø§Ø¦Ø¯ ÙØ±ÙŠØ¯', fault:'ØªÙ„Ù ÙÙŠ Ø§Ù„Ø¬Ù†Ø§Ø²ÙŠØ±',        status:'awaiting', notes:'Ø·Ù„Ø¨ Ø¹Ø§Ø¬Ù„'},
    {id:7,num:'VH-0055',type:'Ù…Ø±Ø§Ø¨',           date:'2026-02-15',building:'B1', engineer:'Ù†Ù‚ÙŠØ¨ Ø­Ø³Ù†',  fault:'Ø¹Ø·Ù„ ÙÙŠ Ø¢Ù„ÙŠØ© Ø§Ù„Ø¨Ø±Ø¬',      status:'repair',   notes:''},
    {id:8,num:'VH-0018',type:'Ø¯Ø±Ø§Ø¬Ø© Ù†Ø§Ø±ÙŠØ©',   date:'2026-01-28',building:'B9', engineer:'Ø¬Ù†Ø¯ÙŠ Ø£Ø­Ù…Ø¯', fault:'ØªØ¢ÙƒÙ„ Ø§Ù„Ø³Ù„Ø³Ù„Ø©',           status:'delivered',notes:''},
  ],
  nextId:9, nextBId:11, nextSId:5,
  // storage[storageNum][vehicleType] = [{id, name, qty, unit, notes}]
  storage:{
    1:{
      'Ù…Ø±Ø§Ø¨':[
        {id:'p1',name:'ÙÙ„ØªØ± Ù‡ÙˆØ§Ø¡',qty:5,unit:'Ù‚Ø·Ø¹Ø©',notes:''},
        {id:'p2',name:'Ø²ÙŠØª Ù…Ø­Ø±Ùƒ',qty:12,unit:'Ù„ØªØ±',notes:''},
        {id:'p3',name:'Ø¨Ø·Ø§Ø±ÙŠØ©',qty:2,unit:'Ù‚Ø·Ø¹Ø©',notes:''},
      ],
      'Ù…Ø¯Ø±Ø¹Ø©':[
        {id:'p4',name:'Ø­Ø²Ø§Ù… Ø¬Ù†Ø²ÙŠØ±',qty:3,unit:'Ù‚Ø·Ø¹Ø©',notes:''},
        {id:'p5',name:'Ù…Ø¶Ø®Ø© ÙˆÙ‚ÙˆØ¯',qty:1,unit:'Ù‚Ø·Ø¹Ø©',notes:''},
      ],
    },
    2:{
      'Ù‡Ø§Ù…ÙÙŠ':[
        {id:'p6',name:'Ø¥Ø·Ø§Ø±',qty:8,unit:'Ù‚Ø·Ø¹Ø©',notes:''},
        {id:'p7',name:'ÙÙ„ØªØ± Ø²ÙŠØª',qty:6,unit:'Ù‚Ø·Ø¹Ø©',notes:''},
      ],
    },
  },
  nextPartId:10,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let buildings=[], vehicleTypes=[], statuses=[], vehicles=[];
let nextId=9, nextBId=11, nextSId=5;
let storageData={1:{},2:{}};
let nextPartId=10;
const PALETTE=['#e8743a','#3ab8e8','#3ae89a','#e84a3a','#e8b13a','#a64de8','#e84a8c','#4de8c2','#e8d83a','#8ce83a'];
let selectedColor=PALETTE[0];
let filterSt='', filterBld='';
let currentUser=null;
let isSaving=false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ø¨Ø± window.storage (Ù…Ø´ØªØ±Ùƒ Ø¨ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHARED_KEY='fleet_shared_data';

async function saveShared(){
  if(isSaving) return;
  isSaving=true;
  setSyncBadge('saving');
  const state={buildings,vehicleTypes,statuses,vehicles,nextId,nextBId,nextSId,storage:storageData,nextPartId,savedAt:Date.now()};
  try{
    await window.storage.set(SHARED_KEY,JSON.stringify(state),true);
    setSyncBadge('synced');
  }catch(e){
    // fallback to localStorage if storage API unavailable
    try{localStorage.setItem('fleet_local',JSON.stringify(state));}catch(e2){}
    setSyncBadge('error','Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·');
  }
  isSaving=false;
}

async function loadShared(){
  showLoading(true);
  try{
    const res=await window.storage.get(SHARED_KEY,true);
    if(res && res.value){
      const state=JSON.parse(res.value);
      applyState(state);
      setSyncBadge('synced');
      showLoading(false);
      return true;
    }
  }catch(e){}
  // fallback: try localStorage
  try{
    const raw=localStorage.getItem('fleet_local');
    if(raw){const state=JSON.parse(raw);applyState(state);setSyncBadge('error','Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·');showLoading(false);return true;}
  }catch(e){}
  // use defaults
  applyState(DEFAULT_DATA);
  setSyncBadge('error','Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
  showLoading(false);
  return false;
}

function applyState(state){
  buildings    = state.buildings    || JSON.parse(JSON.stringify(DEFAULT_DATA.buildings));
  vehicleTypes = state.vehicleTypes || [...DEFAULT_DATA.vehicleTypes];
  statuses     = state.statuses     || JSON.parse(JSON.stringify(DEFAULT_DATA.statuses));
  vehicles     = state.vehicles     || JSON.parse(JSON.stringify(DEFAULT_DATA.vehicles));
  nextId       = state.nextId       || DEFAULT_DATA.nextId;
  nextBId      = state.nextBId      || DEFAULT_DATA.nextBId;
  nextSId      = state.nextSId      || DEFAULT_DATA.nextSId;
  storageData  = state.storage      || JSON.parse(JSON.stringify(DEFAULT_DATA.storage));
  nextPartId   = state.nextPartId   || DEFAULT_DATA.nextPartId;
  // ensure both storage slots exist
  if(!storageData[1]) storageData[1]={};
  if(!storageData[2]) storageData[2]={};
}

function setSyncBadge(type,customText){
  const el=document.getElementById('syncBadge');
  if(!el)return;
  el.className='sync-badge '+type;
  if(type==='synced') el.textContent='âœ“ Ù…ÙØ²Ø§Ù…Ù†';
  else if(type==='saving') el.textContent='âŸ³ Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';
  else el.textContent='âš  '+(customText||'Ø®Ø·Ø£');
}

function showLoading(show){
  document.getElementById('loadingOverlay').classList.toggle('show',show);
}

// auto-reload shared data every 30 seconds while logged in
setInterval(()=>{
  if(currentUser){
    loadShared().then(()=>{if(currentUser)renderAll();});
  }
},30000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const getBld  = id => buildings.find(x=>x.id===id);
const getSt   = id => statuses.find(x=>x.id===id);
const bldName = id => { const b=getBld(id); return b?b.name:id; };
const stName  = id => { const s=getSt(id);  return s?s.name:id; };
const stColor = id => { const s=getSt(id);  return s?s.color:'#5a6478'; };
const fmtDate = d  => d?new Date(d).toLocaleDateString('ar-EG',{day:'2-digit',month:'short',year:'numeric'}):'â€”';
const isAdmin = ()  => currentUser && currentUser.role==='admin';
const userBld = ()  => currentUser ? currentUser.building : null;

function toast(msg,err=false){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.borderColor=err?'var(--red)':'var(--green)';t.style.color=err?'var(--red)':'var(--green)';
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø§Ù„Ø®Ø±ÙˆØ¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value;
  const found=USERS.find(x=>x.username===u&&x.password===p);
  if(!found){
    const err=document.getElementById('loginError');
    err.classList.add('show');setTimeout(()=>err.classList.remove('show'),3000);
    return;
  }
  currentUser=found;
  document.getElementById('loginScreen').style.display='none';
  applyUserContext();
  loadShared().then(()=>{renderAll();toast('Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ '+currentUser.display+'!');});
}

function doLogout(){
  currentUser=null;filterSt='';filterBld='';
  document.getElementById('loginUser').value='';
  document.getElementById('loginPass').value='';
  document.getElementById('loginScreen').style.display='flex';
}

function applyUserContext(){
  document.getElementById('userChipName').textContent=currentUser.display;
  const rb=document.getElementById('userChipRole');
  rb.textContent=isAdmin()?'Ø£Ø¯Ù…Ù†':'Ù…Ø³ØªØ®Ø¯Ù…';
  rb.className='role-badge '+(isAdmin()?'admin':'user');
  document.querySelectorAll('.admin-only').forEach(el=>el.style.display=isAdmin()?'':'none');
  const badge=document.getElementById('buildingBadge');
  if(!isAdmin()&&userBld()){
    badge.style.display='block';
    badge.textContent='ğŸ¢ '+bldName(userBld());
    filterBld=userBld();
    document.getElementById('buildingSelect').style.display='none';
  }else{
    badge.style.display='none';
    document.getElementById('buildingSelect').style.display='';
  }
  document.getElementById('vehicles-subtitle').textContent=
    isAdmin()?'// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª':'// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© â€” '+bldName(userBld());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªÙ†Ù‚Ù„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name,el){
  if(name==='settings'&&!isAdmin()){toast('ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø·Ù„ÙˆØ¨Ø©.',true);return;}
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  el.classList.add('active');
  if(name==='storage1'){populateStorageTypeSelect(1);renderStorage(1);}
  else if(name==='storage2'){populateStorageTypeSelect(2);renderStorage(2);}
  else if(name==='daily'){renderDaily();}
  else renderAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ÙÙ„Ø§ØªØ±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFilterTags(){
  document.getElementById('statusFilterTags').innerHTML=
    `<button class="tag ${filterSt===''?'active':''}" onclick="setStatusFilter('')">Ø§Ù„ÙƒÙ„</button>`+
    statuses.map(s=>`<button class="tag ${filterSt===s.id?'active':''}" onclick="setStatusFilter('${s.id}')">${s.name}</button>`).join('');
}
function setStatusFilter(st){filterSt=st;renderFilterTags();renderVehicles();}
function filterBuilding(){filterBld=document.getElementById('buildingSelect').value;renderVehicles();}

function populateHeaderSelects(){
  const bs=document.getElementById('buildingSelect');
  const saved=bs.value;
  bs.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</option>'+buildings.map(b=>`<option value="${b.id}" ${saved===b.id?'selected':''}>${b.name}</option>`).join('');
}

function populateFormSelects(v=null){
  document.getElementById('f-type').innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>'+vehicleTypes.map(t=>`<option ${v&&v.type===t?'selected':''}>${t}</option>`).join('');
  const mg=document.getElementById('modal-building-group');
  if(!isAdmin()){mg.style.display='none';}
  else{mg.style.display='';document.getElementById('f-building').innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¨Ù†Ù‰</option>'+buildings.map(b=>`<option value="${b.id}" ${v&&v.building===b.id?'selected':''}>${b.name}</option>`).join('');}
  document.getElementById('f-status').innerHTML=statuses.map(s=>`<option value="${s.id}" ${v&&v.status===s.id?'selected':''}>${s.name}</option>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFiltered(){
  const q=document.getElementById('searchInput').value.toLowerCase();
  const bf=isAdmin()?filterBld:userBld();
  return vehicles.filter(v=>
    (!filterSt||v.status===filterSt)&&(!bf||v.building===bf)&&
    (!q||v.num.toLowerCase().includes(q)||(v.engineer||'').toLowerCase().includes(q)));
}

function renderVehicles(){
  renderFilterTags();
  const tbody=document.getElementById('vehiclesBody');
  if(!tbody)return;
  const list=getFiltered();
  if(!list.length){
    tbody.innerHTML=`<tr><td colspan="12" class="vsheet-empty"><div style="font-size:36px;opacity:.3;margin-bottom:12px">ğŸš§</div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ±</td></tr>`;
    return;
  }
  tbody.innerHTML=list.map((v,i)=>{
    const c=stColor(v.status);
    const days=v.date?Math.round((Date.now()-new Date(v.date))/86400000):0;
    const daysColor=days>7?'var(--red)':days>3?'var(--orange)':'var(--green)';
    const opts=statuses.map(s=>`<option value="${s.id}" ${v.status===s.id?'selected':''}>${s.name}</option>`).join('');
    return`<tr>
      <td class="row-num">${i+1}</td>
      <td class="cell-num">${v.num}</td>
      <td>${v.type}</td>
      <td>${v.building?bldName(v.building):'â€”'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:12px">${fmtDate(v.date)}</td>
      <td class="cell-days" style="color:${daysColor}">${days}</td>
      <td>${v.engineer||'â€”'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:12px">${v.tasdiq||'â€”'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:12px">${v.izn||'â€”'}</td>
      <td class="wrap">${v.fault}</td>
      <td>
        <div style="display:flex;align-items:center;gap:6px;background:${c}15;border:1px solid ${c}44;padding:4px 8px;">
          <div class="st-dot" style="background:${c}"></div>
          <select style="background:transparent;border:none;color:${c};font-family:'Cairo',sans-serif;font-size:12px;font-weight:700;cursor:pointer;outline:none;flex:1" onchange="changeStatus(${v.id},this.value)">${opts}</select>
        </div>
      </td>
      <td>
        <div class="cell-actions">
          <button class="btn sm ghost" onclick="openEditModal(${v.id})">ØªØ¹Ø¯ÙŠÙ„</button>
          ${isAdmin()?`<button class="btn sm danger" onclick="deleteVehicle(${v.id})">Ø­Ø°Ù</button>`:''}
        </div>
      </td>
    </tr>`;
  }).join('');
}

function changeStatus(id,st){
  const v=vehicles.find(x=>x.id===id);
  if(v){v.status=st;renderAll();saveShared().then(()=>{});toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: '+stName(st));}
}
function deleteVehicle(id){
  if(!isAdmin()){toast('ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø·Ù„ÙˆØ¨Ø©.',true);return;}
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©ØŸ'))return;
  vehicles=vehicles.filter(v=>v.id!==id);renderAll();saveShared().then(()=>{});toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙƒØ¨Ø©.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddModal(){
  populateFormSelects();
  document.getElementById('modal-title').textContent='ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙƒØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©';
  document.getElementById('f-id').value='';
  ['f-num','f-fault','f-eng','f-notes','f-tasdiq','f-izn'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('modalOverlay').classList.add('open');
}
function openEditModal(id){
  const v=vehicles.find(x=>x.id===id);if(!v)return;
  populateFormSelects(v);
  document.getElementById('modal-title').textContent='ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© â€” '+v.num;
  document.getElementById('f-id').value=v.id;
  document.getElementById('f-num').value=v.num;
  document.getElementById('f-date').value=v.date;
  document.getElementById('f-eng').value=v.engineer||'';
  document.getElementById('f-tasdiq').value=v.tasdiq||'';
  document.getElementById('f-izn').value=v.izn||'';
  document.getElementById('f-fault').value=v.fault;
  document.getElementById('f-notes').value=v.notes||'';
  if(isAdmin())document.getElementById('f-building').value=v.building||'';
  document.getElementById('modalOverlay').classList.add('open');
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('open');}
function closeModalOuter(e){if(e.target===document.getElementById('modalOverlay'))closeModal();}

function saveVehicle(){
  const num=document.getElementById('f-num').value.trim();
  const type=document.getElementById('f-type').value;
  const date=document.getElementById('f-date').value;
  const fault=document.getElementById('f-fault').value.trim();
  const st=document.getElementById('f-status').value;
  if(!num||!type||!date||!fault||!st){toast('âš  ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©.',true);return;}
  const bld=isAdmin()?document.getElementById('f-building').value:userBld();
  const data={num,type,date,fault,status:st,building:bld,
    engineer:document.getElementById('f-eng').value,
    tasdiq:document.getElementById('f-tasdiq').value.trim(),
    izn:document.getElementById('f-izn').value.trim(),
    notes:document.getElementById('f-notes').value};
  const eid=document.getElementById('f-id').value;
  if(eid){const i=vehicles.findIndex(v=>v.id==eid);if(i!==-1)vehicles[i]={...vehicles[i],...data};toast('âœ“ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±ÙƒØ¨Ø©.');}
  else{vehicles.push({id:nextId++,...data});toast('âœ“ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© '+num+'.');}
  closeModal();renderAll();saveShared().then(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcAvgTime(){
  const scope=isAdmin()?vehicles:vehicles.filter(v=>v.building===userBld());
  const done=scope.filter(v=>['repaired','delivered'].includes(v.status));
  if(!done.length)return null;
  return Math.round(done.reduce((a,v)=>a+Math.round((Date.now()-new Date(v.date))/86400000),0)/done.length);
}
function renderReports(){
  const scope=isAdmin()?vehicles:vehicles.filter(v=>v.building===userBld());
  const bySt=id=>scope.filter(v=>v.status===id).length;
  const completed=statuses.filter(s=>['repaired','delivered'].includes(s.id)).reduce((a,s)=>a+bySt(s.id),0);
  const avg=calcAvgTime();
  const bldCounts=buildings.map(b=>({name:b.name,cnt:scope.filter(v=>v.building===b.id).length}));
  const maxBld=bldCounts.reduce((a,b)=>b.cnt>a.cnt?b:a,{cnt:0,name:'â€”'});
  document.getElementById('reportsGrid').innerHTML=`
    <div class="report-card"><div class="report-icon">ğŸš—</div><div class="report-value">${scope.length}</div><div class="report-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</div></div>
    <div class="report-card"><div class="report-icon">âœ…</div><div class="report-value" style="color:var(--green)">${completed}</div><div class="report-label">Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</div></div>
    <div class="report-card"><div class="report-icon">â±ï¸</div><div class="report-value" style="color:var(--accent2);font-size:30px">${avg?avg+' ÙŠÙˆÙ…':'â€”'}</div><div class="report-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div></div>
    ${isAdmin()?`<div class="report-card"><div class="report-icon">ğŸ¢</div><div class="report-value" style="color:var(--red);font-size:24px;line-height:1.2">${maxBld.cnt?maxBld.name:'â€”'}</div><div class="report-label">Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø²Ø¯Ø­Ø§Ù…Ø§Ù‹</div></div>`:''}`;
  document.getElementById('statusBreakdown').innerHTML=
    statuses.map(s=>`<div class="sb-card"><div class="sb-val" style="color:${s.color}">${bySt(s.id)}</div><div class="sb-lab">${s.name}</div></div>`).join('');
  const bcs=document.getElementById('bldChartSection');
  bcs.style.display=isAdmin()?'':'none';
  if(isAdmin()){
    const counts=buildings.map(b=>vehicles.filter(v=>v.building===b.id).length);
    const bMax=Math.max(...counts,1);
    document.getElementById('buildingChart').innerHTML=
      buildings.map((b,i)=>`<div class="bar-group"><div class="bar-val">${counts[i]}</div><div class="bar" style="height:${Math.round((counts[i]/bMax)*110)+4}px"></div><div class="bar-label">${b.name.replace('Ù…Ø¨Ù†Ù‰ ','#')}</div></div>`).join('');
  }
  const days=[];
  for(let i=6;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const str=d.toISOString().split('T')[0];
    days.push({lbl:d.toLocaleDateString('ar-EG',{weekday:'short'}),cnt:scope.filter(v=>v.date===str).length});
  }
  const dMax=Math.max(...days.map(d=>d.cnt),1);
  document.getElementById('dailyChart').innerHTML=
    days.map(d=>`<div class="bar-group"><div class="bar-val">${d.cnt}</div><div class="bar" style="height:${Math.round((d.cnt/dMax)*110)+4}px"></div><div class="bar-label">${d.lbl}</div></div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSidebar(){
  const scope=isAdmin()?vehicles:vehicles.filter(v=>v.building===userBld());
  document.getElementById('sb-total').textContent=scope.length;
  document.getElementById('sb-status-list').innerHTML=
    statuses.map(s=>`<div class="sidebar-stat"><span>${s.name}</span><span class="val" style="color:${s.color}">${scope.filter(v=>v.status===s.id).length}</span></div>`).join('');
  const avg=calcAvgTime();
  document.getElementById('sb-avg').textContent=avg?avg+' ÙŠÙˆÙ…':'â€”';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeListItem(label,colorDot,onEdit,onDelete){
  const li=document.createElement('li');
  const row=document.createElement('div');row.className='item-row';
  if(colorDot){const dot=document.createElement('div');dot.className='item-color-dot';dot.style.background=colorDot;row.appendChild(dot);}
  const ns=document.createElement('div');ns.className='item-name';ns.textContent=label;row.appendChild(ns);
  const eb=document.createElement('button');eb.className='btn sm ghost';eb.textContent='ØªØ¹Ø¯ÙŠÙ„';row.appendChild(eb);
  const db=document.createElement('button');db.className='btn sm danger';db.textContent='âœ•';row.appendChild(db);
  const er=document.createElement('div');er.className='item-edit-row';
  const inp=document.createElement('input');inp.type='text';inp.value=label;
  const sb=document.createElement('button');sb.className='btn sm';sb.textContent='Ø­ÙØ¸';
  er.appendChild(inp);er.appendChild(sb);li.appendChild(row);li.appendChild(er);
  eb.onclick=()=>{const open=er.classList.contains('active');ns.style.display=open?'':'none';er.classList.toggle('active',!open);if(!open)inp.focus();};
  sb.onclick=()=>{const v=inp.value.trim();if(!v)return;ns.textContent=v;ns.style.display='';er.classList.remove('active');onEdit(v);};
  inp.onkeydown=e=>{if(e.key==='Enter')sb.click();};
  db.onclick=onDelete;
  return li;
}
function renderSettingsBuildings(){
  const ul=document.getElementById('buildings-list');if(!ul)return;ul.innerHTML='';
  buildings.forEach(b=>ul.appendChild(makeListItem(b.name,null,
    v=>{b.name=v;renderAll();saveShared().then(()=>{});toast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰.');},
    ()=>deleteBuilding(b.id))));
}
function addBuilding(){
  const v=document.getElementById('new-building').value.trim();
  if(!v){toast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰.',true);return;}
  buildings.push({id:'B'+(nextBId++),name:v});
  document.getElementById('new-building').value='';renderAll();saveShared().then(()=>{});toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù†Ù‰: '+v);
}
function deleteBuilding(id){
  if(vehicles.some(v=>v.building===id)&&!confirm('ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù†Ù‰. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ'))return;
  buildings=buildings.filter(b=>b.id!==id);vehicles.forEach(v=>{if(v.building===id)v.building='';});
  renderAll();saveShared().then(()=>{});toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ù†Ù‰.');
}
function renderSettingsTypes(){
  const ul=document.getElementById('types-list');if(!ul)return;ul.innerHTML='';
  vehicleTypes.forEach((t,i)=>ul.appendChild(makeListItem(t,null,
    v=>{vehicleTypes[i]=v;renderAll();saveShared().then(()=>{});toast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù†ÙˆØ¹.');},
    ()=>{if(!confirm('Ø­Ø°Ù Ø§Ù„Ù†ÙˆØ¹ "'+vehicleTypes[i]+'"ØŸ'))return;vehicleTypes.splice(i,1);renderAll();saveShared().then(()=>{});toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†ÙˆØ¹.');})));
}
function addType(){
  const v=document.getElementById('new-type').value.trim();
  if(!v){toast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù†ÙˆØ¹.',true);return;}
  vehicleTypes.push(v);document.getElementById('new-type').value='';renderAll();saveShared().then(()=>{});toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ÙˆØ¹: '+v);
}
function renderSettingsStatuses(){
  const ul=document.getElementById('statuses-list');if(!ul)return;ul.innerHTML='';
  statuses.forEach(s=>ul.appendChild(makeListItem(s.name,s.color,
    v=>{s.name=v;renderAll();saveShared().then(()=>{});toast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø©.');},
    ()=>deleteStatus(s.id))));
  document.getElementById('colorSwatches').innerHTML=PALETTE.map(c=>
    `<div class="swatch ${selectedColor===c?'selected':''}" style="background:${c}" onclick="selectColor('${c}')"></div>`).join('');
}
function selectColor(c){selectedColor=c;renderSettingsStatuses();}
function addStatus(){
  const v=document.getElementById('new-status').value.trim();
  if(!v){toast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø©.',true);return;}
  statuses.push({id:'st'+(nextSId++),name:v,color:selectedColor});
  document.getElementById('new-status').value='';renderAll();saveShared().then(()=>{});toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„Ø©: '+v);
}
function deleteStatus(id){
  if(statuses.length<=1){toast('ÙŠØ¬Ø¨ Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø©.',true);return;}
  if(vehicles.some(v=>v.status===id)&&!confirm('ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø§Øª Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ'))return;
  statuses=statuses.filter(s=>s.id!==id);vehicles.forEach(v=>{if(v.status===id)v.status=statuses[0].id;});
  renderAll();saveShared().then(()=>{});toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø§Ù„Ø©.');
}
function renderSettings(){
  if(!isAdmin())return;
  renderSettingsBuildings();renderSettingsTypes();renderSettingsStatuses();renderDataInfo();
}
function renderDataInfo(){
  const el=document.getElementById('dataInfo');if(!el)return;
  el.innerHTML=`Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª: <span>${vehicles.length}</span> | Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ: <span>${buildings.length}</span> | Ø§Ù„Ø­Ø§Ù„Ø§Øª: <span>${statuses.length}</span><br>ÙˆØ¶Ø¹ Ø§Ù„Ø­ÙØ¸: <span>Ù…Ø´ØªØ±Ùƒ Ø¨ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªØµØ¯ÙŠØ± / Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ / Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function forceSave(){saveShared().then(()=>{toast('âœ“ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©.');});}
function exportData(){
  const state={buildings,vehicleTypes,statuses,vehicles,nextId,nextBId,nextSId,storage:storageData,nextPartId,exportedAt:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download='Ù…ØªØ§Ø¨Ø¹Ø©-Ø§Ù„Ø§Ù†ØªØ§Ø¬-'+new Date().toISOString().split('T')[0]+'.json';
  a.click();URL.revokeObjectURL(url);toast('âœ“ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
}
function importData(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const state=JSON.parse(e.target.result);
      if(!state.vehicles||!state.buildings)throw new Error();
      if(!confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'))return;
      applyState(state);renderAll();saveShared().then(()=>{});toast('âœ“ ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.');
    }catch{toast('âš  Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.',true);}
    event.target.value='';
  };reader.readAsText(file);
}
function resetToDefaults(){
  if(!confirm('Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.'))return;
  applyState(JSON.parse(JSON.stringify(DEFAULT_DATA)));
  renderAll();saveShared().then(()=>{});toast('â†º ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDaily(){
  const today=new Date();
  const todayStr=today.toISOString().split('T')[0];

  // Date badge
  const dayNames=['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
  const fullDate=today.toLocaleDateString('ar-EG',{day:'numeric',month:'long',year:'numeric'});
  document.getElementById('dailyDateBadge').innerHTML=
    `<div class="ddb-day">${today.getDate()}</div><div class="ddb-full">${dayNames[today.getDay()]}<br>${fullDate}</div>`;
  document.getElementById('daily-date-sub').textContent='// Ù…Ù„Ø®Øµ ÙŠÙˆÙ… '+fullDate;

  // Scope: admin sees all, user sees their building
  const scope=isAdmin()?vehicles:vehicles.filter(v=>v.building===userBld());

  // Entered today
  const enteredToday=scope.filter(v=>v.date===todayStr);

  // Done today = repaired or delivered, entered today OR we track all with those statuses
  // We show repaired/delivered entered today, plus all currently repaired/delivered as "active completions"
  const doneStatuses=statuses.filter(s=>s.id==='repaired'||s.id==='delivered').map(s=>s.id);
  const doneToday=scope.filter(v=>doneStatuses.includes(v.status)&&v.date===todayStr);

  // Currently active (under repair or awaiting)
  const activeStatuses=statuses.filter(s=>!doneStatuses.includes(s.id)).map(s=>s.id);
  const activeVehicles=scope.filter(v=>activeStatuses.includes(v.status));

  // Awaiting parts specifically
  const awaitingCount=scope.filter(v=>v.status==='awaiting').length;

  // Low stock parts
  const lowParts=[];
  [1,2].forEach(num=>{
    const slot=storageData[num]||{};
    Object.entries(slot).forEach(([type,parts])=>{
      parts.forEach(p=>{
        if(p.qty<=2) lowParts.push({...p,storageNum:num,vehicleType:type});
      });
    });
  });

  // â”€â”€ KPIs â”€â”€
  document.getElementById('dailyKpiRow').innerHTML=`
    <div class="daily-kpi accent"><div class="kpi-icon">ğŸš—</div><div class="kpi-val accent">${scope.length}</div><div class="kpi-lab">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</div></div>
    <div class="daily-kpi green"><div class="kpi-icon">ğŸ“¥</div><div class="kpi-val green">${enteredToday.length}</div><div class="kpi-lab">Ø¯Ø®Ù„Øª Ø§Ù„ÙŠÙˆÙ…</div></div>
    <div class="daily-kpi blue"><div class="kpi-icon">âœ…</div><div class="kpi-val blue">${doneToday.length}</div><div class="kpi-lab">Ù…Ù†Ø¬Ø²Ø© Ø§Ù„ÙŠÙˆÙ…</div></div>
    <div class="daily-kpi orange"><div class="kpi-icon">ğŸ”§</div><div class="kpi-val orange">${activeVehicles.length}</div><div class="kpi-lab">Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div></div>
    <div class="daily-kpi red"><div class="kpi-icon">â³</div><div class="kpi-val red">${awaitingCount}</div><div class="kpi-lab">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹</div></div>
    ${isAdmin()?`<div class="daily-kpi red"><div class="kpi-icon">âš ï¸</div><div class="kpi-val red">${lowParts.length}</div><div class="kpi-lab">Ù‚Ø·Ø¹ Ù…Ù†Ø®ÙØ¶Ø©</div></div>`:''}`;

  // â”€â”€ Entered today table â”€â”€
  document.getElementById('daily-entered-sub').textContent=
    enteredToday.length?`// ${enteredToday.length} Ù…Ø±ÙƒØ¨Ø© Ø¯Ø®Ù„Øª Ø§Ù„ÙŠÙˆÙ…`:'// Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø§Øª Ø¯Ø®Ù„Øª Ø§Ù„ÙŠÙˆÙ…';
  document.getElementById('dailyEnteredBody').innerHTML=enteredToday.length
    ?enteredToday.map(v=>{const c=stColor(v.status);return`<tr>
        <td><strong style="font-family:'JetBrains Mono',monospace">${v.num}</strong></td>
        <td>${v.type}</td>
        <td>${v.building?bldName(v.building):'â€”'}</td>
        <td>${v.engineer||'â€”'}</td>
        <td>${v.fault}</td>
        <td><span class="st-pill" style="color:${c};border-color:${c}44;background:${c}15">${stName(v.status)}</span></td>
      </tr>`;}).join('')
    :`<tr><td colspan="6" class="daily-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø§Øª Ø¯Ø®Ù„Øª Ø§Ù„ÙŠÙˆÙ…</td></tr>`;

  // â”€â”€ Done today table â”€â”€
  document.getElementById('daily-done-sub').textContent=
    doneToday.length?`// ${doneToday.length} Ù…Ø±ÙƒØ¨Ø© ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡Ø§ Ø§Ù„ÙŠÙˆÙ…`:'// Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø§Øª Ù…Ù†Ø¬Ø²Ø© Ø§Ù„ÙŠÙˆÙ…';
  document.getElementById('dailyDoneBody').innerHTML=doneToday.length
    ?doneToday.map(v=>{const c=stColor(v.status);return`<tr>
        <td><strong style="font-family:'JetBrains Mono',monospace">${v.num}</strong></td>
        <td>${v.type}</td>
        <td>${v.building?bldName(v.building):'â€”'}</td>
        <td>${v.engineer||'â€”'}</td>
        <td>${v.fault}</td>
        <td><span class="st-pill" style="color:${c};border-color:${c}44;background:${c}15">${stName(v.status)}</span></td>
      </tr>`;}).join('')
    :`<tr><td colspan="6" class="daily-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø§Øª Ù…Ù†Ø¬Ø²Ø© Ø§Ù„ÙŠÙˆÙ…</td></tr>`;

  // â”€â”€ Active vehicles grouped by building â”€â”€
  document.getElementById('daily-active-sub').textContent=
    `// ${activeVehicles.length} Ù…Ø±ÙƒØ¨Ø© Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹`;
  if(!activeVehicles.length){
    document.getElementById('dailyActiveBldGroups').innerHTML=
      '<div class="daily-empty" style="padding:20px 0">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
  }else{
    // group by building
    const groups={};
    activeVehicles.forEach(v=>{
      const bk=v.building||'__none__';
      if(!groups[bk])groups[bk]=[];
      groups[bk].push(v);
    });
    document.getElementById('dailyActiveBldGroups').innerHTML=
      Object.entries(groups).map(([bk,vlist])=>`
        <div class="daily-bld-group">
          <div class="daily-bld-label">
            ğŸ¢ ${bk==='__none__'?'ØºÙŠØ± Ù…Ø­Ø¯Ø¯':bldName(bk)}
            <span>${vlist.length} Ù…Ø±ÙƒØ¨Ø©</span>
          </div>
          <div class="daily-table-wrap">
            <table class="daily-table">
              <thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¶Ø§Ø¨Ø· / Ø¶Ø§Ø¨Ø· Ø§Ù„ØµÙ</th><th>Ø§Ù„Ø¹Ø·Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø£ÙŠØ§Ù… Ù…Ù†Ø° Ø§Ù„Ø¯Ø®ÙˆÙ„</th></tr></thead>
              <tbody>${vlist.map(v=>{
                const c=stColor(v.status);
                const days=v.date?Math.round((Date.now()-new Date(v.date))/86400000):0;
                const daysColor=days>7?'var(--red)':days>3?'var(--orange)':'var(--text)';
                return`<tr>
                  <td><strong style="font-family:'JetBrains Mono',monospace">${v.num}</strong></td>
                  <td>${v.type}</td>
                  <td>${v.engineer||'â€”'}</td>
                  <td>${v.fault}</td>
                  <td><span class="st-pill" style="color:${c};border-color:${c}44;background:${c}15">${stName(v.status)}</span></td>
                  <td style="color:${daysColor};font-weight:700;font-family:'JetBrains Mono',monospace">${days} ÙŠÙˆÙ…</td>
                </tr>`;}).join('')}
              </tbody>
            </table>
          </div>
        </div>`).join('');
  }

  // â”€â”€ Low stock parts (admin only) â”€â”€
  const lpSection=document.getElementById('daily-low-parts-section');
  if(!isAdmin()){lpSection.style.display='none';return;}
  lpSection.style.display='';
  document.getElementById('dailyLowParts').innerHTML=lowParts.length
    ?lowParts.map(p=>`
        <div class="low-part-card">
          <div class="low-part-info">
            <div class="low-part-name">${p.name}</div>
            <div class="low-part-meta">${p.vehicleType} â€” Ù…Ø³Ø§Ø­Ø© ØªØ®Ø²ÙŠÙ† ${p.storageNum}</div>
          </div>
          <div class="low-part-qty">${p.qty}</div>
        </div>`)
      .join('')
    :'<div class="daily-empty" style="padding:16px 0">âœ… Ø¬Ù…ÙŠØ¹ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø¨Ù…Ø³ØªÙˆÙ‰ ÙƒØ§ÙÙ</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateStorageTypeSelect(num){
  if(num===2) return; // storage2 has hardcoded MRAP options
  const sel=document.getElementById('storageTypeSelect'+num);
  const cur=sel.value;
  sel.innerHTML='<option value="">â€” Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© â€”</option>'+
    vehicleTypes.map(t=>`<option value="${t}" ${cur===t?'selected':''}>${t}</option>`).join('');
}

function renderStorage(num){
  populateStorageTypeSelect(num);
  const sel=document.getElementById('storageTypeSelect'+num);
  const type=sel.value;
  const summaryEl=document.getElementById('storage'+num+'-summary');

  // Summary stats
  const slot=storageData[num]||{};
  let totalParts=0,totalQty=0,lowCount=0;
  Object.values(slot).forEach(parts=>{
    parts.forEach(p=>{totalParts++;totalQty+=p.qty;if(p.qty<=10)lowCount++;});
  });
  summaryEl.innerHTML=`
    <div class="stor-stat"><div class="stor-stat-val">${totalParts}</div><div class="stor-stat-lab">Ù†ÙˆØ¹ Ù‚Ø·Ø¹Ø©</div></div>
    <div class="stor-stat"><div class="stor-stat-val">${totalQty}</div><div class="stor-stat-lab">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</div></div>
    <div class="stor-stat"><div class="stor-stat-val" style="color:${lowCount>0?'var(--red)':'var(--accent)'}">${lowCount}</div><div class="stor-stat-lab">Ù‚Ø·Ø¹ Ù…Ù†Ø®ÙØ¶Ø© (â‰¤10)</div></div>`;

  if(num===1){
    renderStorage1Sheet(type,slot);
  } else {
    renderStorageSheet(2,type,slot);
  }
}

function renderStorageSheet(num,type,slot){
  const sheet=document.getElementById('partsSheet'+num);
  const grid=document.getElementById('partsGrid'+num);
  const searchEl=document.getElementById('storageSearch'+num);
  const q=(searchEl?searchEl.value:'').toLowerCase().trim();

  if(!type){
    sheet.style.display='none';
    grid.innerHTML='<div class="empty"><div class="empty-icon">ğŸ”§</div>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù„Ø¹Ø±Ø¶ Ù‚Ø·Ø¹Ù‡Ø§</div>';
    return;
  }
  grid.innerHTML='';
  sheet.style.display='';
  let parts=slot[type]||[];

  // apply search filter
  if(q){
    parts=parts.filter(p=>
      (p.name||'').toLowerCase().includes(q)||
      (p.nsn||'').toLowerCase().includes(q)||
      (p.pn||'').toLowerCase().includes(q)
    );
  }

  const allParts=slot[type]||[]; // for index reference
  const tbody=document.getElementById('partsBody'+num);
  let rowNum=0;
  tbody.innerHTML=parts.map((p)=>{
    rowNum++;
    const qtyClass=p.qty<=10?'qty-color-low':'qty-color-ok';
    return`<tr>
      <td class="row-num">${rowNum}</td>
      <td><input class="ssheet-input" value="${p.name||''}" onchange="updatePartField(${num},'${type}','${p.id}','name',this.value)" placeholder="Ø£Ø³Ù… Ø§Ù„ØµÙ†Ù"/></td>
      <td><input class="ssheet-input mono" value="${p.nsn||''}" onchange="updatePartField(${num},'${type}','${p.id}','nsn',this.value)" placeholder="NSN"/></td>
      <td><input class="ssheet-input mono" value="${p.pn||''}" onchange="updatePartField(${num},'${type}','${p.id}','pn',this.value)" placeholder="P/N"/></td>
      <td style="text-align:center">
        <div style="display:flex;align-items:center;justify-content:center;gap:4px">
          <button class="qty-btn" onclick="adjustQty(${num},'${type}','${p.id}',-1)">âˆ’</button>
          <input class="ssheet-qty ${qtyClass}" type="number" value="${p.qty}" min="0" onchange="setQty(${num},'${type}','${p.id}',this.value)"/>
          <button class="qty-btn" onclick="adjustQty(${num},'${type}','${p.id}',+1)">+</button>
        </div>
      </td>
      <td><button class="btn sm danger" onclick="deletePart(${num},'${type}','${p.id}')">Ø­Ø°Ù</button></td>
    </tr>`;
  }).join('');

  // show "no results" row when searching
  if(q && parts.length===0){
    tbody.innerHTML=`<tr><td colspan="6" class="vsheet-empty" style="padding:24px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«</td></tr>`;
  }

  // always show add-row in tfoot (not affected by search)
  document.getElementById('partsTfoot'+num).innerHTML=`<tr class="ssheet-add-row">
    <td style="text-align:center;color:var(--accent);font-weight:700;font-size:16px">+</td>
    <td><input id="np-name-${num}" placeholder="Ø£Ø³Ù… Ø§Ù„ØµÙ†Ù *" onkeydown="if(event.key==='Enter')addPartSheet(${num},'${type}')"/></td>
    <td><input id="np-nsn-${num}" class="mono" placeholder="NSN" onkeydown="if(event.key==='Enter')addPartSheet(${num},'${type}')"/></td>
    <td><input id="np-pn-${num}" class="mono" placeholder="P/N" onkeydown="if(event.key==='Enter')addPartSheet(${num},'${type}')"/></td>
    <td><input id="np-qty-${num}" type="number" value="1" min="0" style="width:70px;text-align:center" onkeydown="if(event.key==='Enter')addPartSheet(${num},'${type}')"/></td>
    <td><button class="btn sm" onclick="addPartSheet(${num},'${type}')">Ø¥Ø¶Ø§ÙØ©</button></td>
  </tr>`;
}

// alias for storage1 (kept for backward compat)
function renderStorage1Sheet(type,slot){ renderStorageSheet(1,type,slot); }

function addPartSheet(num,type){
  const name=document.getElementById('np-name-'+num).value.trim();
  if(!name){toast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù… Ø§Ù„ØµÙ†Ù.',true);return;}
  const nsn=document.getElementById('np-nsn-'+num).value.trim();
  const pn=document.getElementById('np-pn-'+num).value.trim();
  const qty=Math.max(0,parseInt(document.getElementById('np-qty-'+num).value)||0);
  if(!storageData[num])storageData[num]={};
  if(!storageData[num][type])storageData[num][type]=[];
  storageData[num][type].push({id:'p'+(nextPartId++),name,nsn,pn,qty,unit:'Ù‚Ø·Ø¹Ø©',notes:''});
  renderStorage(num);saveShared().then(()=>{});toast('âœ“ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù: '+name);
}

// kept for storage2 old calls â€” now replaced by addPartSheet
function addPart1(type){ addPartSheet(1,type); }

function adjustQty(num,type,partId,delta){
  const slot=storageData[num];if(!slot||!slot[type])return;
  const p=slot[type].find(x=>x.id===partId);if(!p)return;
  p.qty=Math.max(0,p.qty+delta);
  renderStorage(num);saveShared().then(()=>{});
}

function setQty(num,type,partId,val){
  const slot=storageData[num];if(!slot||!slot[type])return;
  const p=slot[type].find(x=>x.id===partId);if(!p)return;
  p.qty=Math.max(0,parseInt(val)||0);
  saveShared().then(()=>{});
  // just refresh summary without full re-render to avoid losing focus
  renderStorage(num);
}

function deletePart(num,type,partId){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø·Ø¹Ø©ØŸ'))return;
  if(!storageData[num]||!storageData[num][type])return;
  storageData[num][type]=storageData[num][type].filter(p=>p.id!==partId);
  renderStorage(num);saveShared().then(()=>{});toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø·Ø¹Ø©.');
}

function addPart(num,type){
  const name=document.getElementById('np-name-'+num).value.trim();
  if(!name){toast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©.',true);return;}
  const qty=Math.max(0,parseInt(document.getElementById('np-qty-'+num).value)||0);
  const unit=document.getElementById('np-unit-'+num).value.trim()||'Ù‚Ø·Ø¹Ø©';
  const notes=document.getElementById('np-notes-'+num).value.trim();
  if(!storageData[num])storageData[num]={};
  if(!storageData[num][type])storageData[num][type]=[];
  storageData[num][type].push({id:'p'+(nextPartId++),name,qty,unit,notes});
  renderStorage(num);saveShared().then(()=>{});toast('âœ“ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø·Ø¹Ø©: '+name);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªØµÙŠÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  if(!currentUser)return;
  populateHeaderSelects();renderFilterTags();renderVehicles();updateSidebar();renderReports();renderSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('loginUser').focus();
</script>
</body>
</html>